"use strict";(self["webpackChunkfrontend"]=self["webpackChunkfrontend"]||[]).push([[374],{4374:function(e,t,n){n.r(t),n.d(t,{default:function(){return W}});var o=n(6768),a=n(5130),i=n(4232);const l=e=>((0,o.Qi)("data-v-78bf9458"),e=e(),(0,o.jt)(),e),r={class:"havaleh-form"},s=l((()=>(0,o.Lk)("h2",null,"حواله خروج از انبار",-1))),d={key:0,class:"loading-state"},u=l((()=>(0,o.Lk)("p",null,"در حال بارگیری اطلاعات فاکتور...",-1))),c=[u],m={key:1,class:"no-invoice"},h=l((()=>(0,o.Lk)("p",null,"فاکتوری با وضعیت تایید نشده وجود ندارد.",-1))),p=[h],k={key:2},g={class:"form-header"},f={class:"form-group"},L=l((()=>(0,o.Lk)("label",null,"تاریخ ارسال:",-1))),v={class:"form-group"},b=l((()=>(0,o.Lk)("label",null,"شماره سریال:",-1))),w={class:"form-group"},y=l((()=>(0,o.Lk)("label",null,"شماره فاکتور:",-1))),D={class:"form-group"},I=l((()=>(0,o.Lk)("label",null,"مشتری:",-1))),C={class:"items-table"},U=l((()=>(0,o.Lk)("thead",null,[(0,o.Lk)("tr",null,[(0,o.Lk)("th",null,"ردیف"),(0,o.Lk)("th",null,"نام کالا و مشخصات کالا"),(0,o.Lk)("th",null,"گرماژ"),(0,o.Lk)("th",null,"عرض کاغذ"),(0,o.Lk)("th",null,"نام خریدار"),(0,o.Lk)("th",null,"تعداد / مقدار"),(0,o.Lk)("th",null,"وزن کالا"),(0,o.Lk)("th",null,"عملیات")])],-1))),_=["onUpdate:modelValue"],F=["onUpdate:modelValue"],V=["onUpdate:modelValue"],P=["onUpdate:modelValue"],E=["onUpdate:modelValue"],J=["onUpdate:modelValue"],$=["onClick"],x={class:"form-footer"},S={class:"form-group"},T=l((()=>(0,o.Lk)("label",null,"ملاحظات:",-1))),j={class:"total-weight"},X=l((()=>(0,o.Lk)("strong",null,"جمع کل وزن:",-1))),R={class:"button-group"};function O(e,t,n,l,u,h){return(0,o.uX)(),(0,o.CE)("div",r,[s,u.loading?((0,o.uX)(),(0,o.CE)("div",d,c)):u.hasInvoice?((0,o.uX)(),(0,o.CE)("div",k,[(0,o.Lk)("div",g,[(0,o.Lk)("div",f,[L,(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=e=>u.formData.date=e),readonly:""},null,512),[[a.Jo,u.formData.date]])]),(0,o.Lk)("div",v,[b,(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[1]||(t[1]=e=>u.formData.serial=e)},null,512),[[a.Jo,u.formData.serial]])]),(0,o.Lk)("div",w,[y,(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[2]||(t[2]=e=>u.pendingInvoice.invoice_number=e),readonly:""},null,512),[[a.Jo,u.pendingInvoice.invoice_number]])]),(0,o.Lk)("div",D,[I,(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=e=>u.pendingInvoice.customer_name=e),readonly:""},null,512),[[a.Jo,u.pendingInvoice.customer_name]])])]),(0,o.Lk)("div",C,[(0,o.Lk)("table",null,[U,(0,o.Lk)("tbody",null,[((0,o.uX)(!0),(0,o.CE)(o.FK,null,(0,o.pI)(u.formData.items,((e,t)=>((0,o.uX)(),(0,o.CE)("tr",{key:t},[(0,o.Lk)("td",null,(0,i.v_)(t+1),1),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t=>e.name=t},null,8,_),[[a.Jo,e.name]])]),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t=>e.gsm=t},null,8,F),[[a.Jo,e.gsm]])]),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t=>e.width=t},null,8,V),[[a.Jo,e.width]])]),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"text","onUpdate:modelValue":t=>e.buyer=t},null,8,P),[[a.Jo,e.buyer]])]),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"number","onUpdate:modelValue":t=>e.quantity=t},null,8,E),[[a.Jo,e.quantity]])]),(0,o.Lk)("td",null,[(0,o.bo)((0,o.Lk)("input",{type:"number","onUpdate:modelValue":t=>e.weight=t},null,8,J),[[a.Jo,e.weight]])]),(0,o.Lk)("td",null,[(0,o.Lk)("button",{onClick:e=>h.removeItem(t),class:"remove-btn"},"حذف",8,$)])])))),128))])]),(0,o.Lk)("button",{onClick:t[4]||(t[4]=(...e)=>h.addItem&&h.addItem(...e)),class:"add-btn"},"افزودن ردیف جدید")]),(0,o.Lk)("div",x,[(0,o.Lk)("div",S,[T,(0,o.bo)((0,o.Lk)("textarea",{"onUpdate:modelValue":t[5]||(t[5]=e=>u.formData.note=e)},null,512),[[a.Jo,u.formData.note]])]),(0,o.Lk)("div",j,[X,(0,o.eW)(" "+(0,i.v_)(h.calculateTotalWeight()),1)]),(0,o.Lk)("div",R,[(0,o.Lk)("button",{onClick:t[6]||(t[6]=(...e)=>h.confirmInvoiceAndGeneratePDF&&h.confirmInvoiceAndGeneratePDF(...e)),class:"confirm-btn"},"تایید فاکتور و تولید PDF"),(0,o.Lk)("button",{onClick:t[7]||(t[7]=(...e)=>h.generatePDF&&h.generatePDF(...e)),class:"generate-btn"},"تولید PDF بدون تایید")])])])):((0,o.uX)(),(0,o.CE)("div",m,p))])}n(4114),n(4603),n(7566),n(8721);var q={name:"Havaleh",data(){return{loading:!0,hasInvoice:!1,pendingInvoice:null,formData:{date:this.getCurrentDate(),serial:"",items:[],note:""}}},created(){this.fetchLatestPendingInvoice()},methods:{async fetchLatestPendingInvoice(){try{this.loading=!0;const e=window.location.origin,t=await fetch(`${e}/myapp/api/latest-pending-sale/`);if(!t.ok){if(404===t.status)return this.hasInvoice=!1,void(this.loading=!1);throw new Error(`Error ${t.status}: ${await t.text()}`)}const n=await t.json();if(this.pendingInvoice=n,this.hasInvoice=!0,this.formData.serial=`HV-${n.id}`,n.list_of_reels){const e=n.list_of_reels.split(",");e.forEach((t=>{this.formData.items.push({name:`رول ${t.trim()}`,gsm:"",width:n.width||"",buyer:n.customer_name||"",quantity:1,weight:n.net_weight?Math.round(n.net_weight/e.length):0})}))}else this.addItem(),this.formData.items.length>0&&(this.formData.items[0].buyer=n.customer_name||"",this.formData.items[0].width=n.width||"",this.formData.items[0].weight=n.net_weight||0)}catch(e){console.error("Error fetching pending invoice:",e),this.hasInvoice=!1}finally{this.loading=!1}},getCurrentDate(){const e=new Date,t=e.getFullYear(),n=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${t}/${n}/${o}`},addItem(){this.formData.items.push({name:"",gsm:"",width:"",buyer:this.pendingInvoice?.customer_name||"",quantity:"",weight:""})},removeItem(e){this.formData.items.splice(e,1)},calculateTotalWeight(){return this.formData.items.reduce(((e,t)=>e+(parseFloat(t.weight)||0)),0).toLocaleString()},async confirmInvoiceAndGeneratePDF(){if(this.pendingInvoice&&this.pendingInvoice.id)try{const e=window.location.origin,t=await fetch(`${e}/myapp/api/confirm-sales-invoice/${this.pendingInvoice.id}/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCookie("csrftoken")},credentials:"include"});if(!t.ok){const e=await t.json();throw new Error(e.error||"خطا در تایید فاکتور")}await this.generatePDF(),setTimeout((()=>{this.fetchLatestPendingInvoice()}),1e3)}catch(e){console.error("خطا در تایید فاکتور:",e),alert("خطا در تایید فاکتور: "+e.message)}else alert("هیچ فاکتوری برای تایید وجود ندارد.")},async generatePDF(){try{const e={date:this.formData.date,serial:this.formData.serial,items:this.formData.items,note:this.formData.note,invoice_id:this.pendingInvoice?.id};console.log("Form data being sent:",e);const t=window.location.origin,n=await fetch(`${t}/myapp/api/havaleh-pdf/`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":this.getCookie("csrftoken")},body:JSON.stringify(e),credentials:"include"});if(!n.ok){const e=await n.json();throw new Error(e.error||"Error generating PDF")}const o=await n.blob(),a=window.URL.createObjectURL(o),i=document.createElement("a");i.href=a,i.download=`havaleh_${this.formData.serial}.pdf`,document.body.appendChild(i),i.click(),window.URL.revokeObjectURL(a),document.body.removeChild(i)}catch(e){console.error("خطا در تولید PDF:",e),alert("خطا در تولید PDF: "+e.message)}},getCookie(e){let t=null;if(document.cookie&&""!==document.cookie){const n=document.cookie.split(";");for(let o=0;o<n.length;o++){const a=n[o].trim();if(a.substring(0,e.length+1)===e+"="){t=decodeURIComponent(a.substring(e.length+1));break}}}return t}}},A=n(1241);const G=(0,A.A)(q,[["render",O],["__scopeId","data-v-78bf9458"]]);var W=G}}]);
//# sourceMappingURL=374.662777d8.js.map